# AI Agent Context for elm-to-react

This file provides essential context for AI agents (LLMs) working on this project.

## Project Overview

**elm-to-react** is a source-to-source transpiler that converts Elm code to TypeScript/React. Currently in early development, focusing on parsing Elm files with tree-sitter.

## Technology Stack

- **Language**: TypeScript (Node.js 24+)
- **Package Manager**: Yarn 4
- **Parser**: tree-sitter with @elm-tooling/tree-sitter-elm
- **CLI Framework**: Effect CLI
- **Dev Environment**: Nix (optional but recommended)
- **Runtime**: Node.js with `--experimental-strip-types`

## Quick Start (Single Command)

To run the application:

```bash
nix develop -c elm-to-react --entry /home/ben/Code/elm-to-react/examples/Simple.elm
```

Or if already in the nix shell:

```bash
elm-to-react --entry /home/ben/Code/elm-to-react/examples/Simple.elm
```

## Project Structure

```
.
├── src/
│   ├── main.ts                 # CLI entry point (Effect CLI)
│   └── parser/
│       ├── index.ts            # Elm parser using tree-sitter
│       └── cst-types/          # Generated TypeScript definitions for Elm CST
├── examples/
│   └── Simple.elm              # Example Elm file for testing
├── bin/
│   └── elm-to-react           # Shell script wrapper for dev CLI
├── scripts/
│   └── gen-cst-types.ts       # Script to generate CST type definitions
├── flake.nix                  # Nix development environment
└── package.json               # Dependencies and scripts
```

## Key Files for Development

- **`src/main.ts`**: CLI application entry point using Effect
- **`src/parser/index.ts`**: Tree-sitter parser for Elm files
- **`src/parser/cst-types/index.d.ts`**: Generated TypeScript types for Elm AST nodes
- **`bin/elm-to-react`**: Dev wrapper script (resolves to `src/main.ts`)

## Common Development Commands

```bash
# Generate CST types from tree-sitter grammar
yarn gen:cst-types

# Run in development mode (without Nix)
yarn dev --entry examples/Simple.elm

# Build for production
yarn build

# Type check
yarn typecheck

# Lint
yarn lint

# Format code
yarn format
```

## Development Environment

### With Nix (Recommended)

```bash
# Enter development shell
nix develop

# Install dependencies
yarn install

# Generate CST types (required after fresh install)
yarn gen:cst-types

# Run the app
elm-to-react --entry examples/Simple.elm
```

### Without Nix

Requires Node.js 24+ and Yarn 4+ installed locally. Same commands as above, but skip `nix develop`.

## Important Implementation Details

### TypeScript Module System

- **Type**: ESM (`"type": "module"` in package.json)
- **Module**: NodeNext (supports both ESM and CommonJS interop)
- **Imports**: Must use `.js` extensions in import statements (even for `.ts` files)
- **Runtime**: Uses Node's `--experimental-strip-types` for fast execution

### Tree-sitter Integration

- Parser uses CommonJS imports: `import BaseParser = require("tree-sitter")`
- Generated types are imported as namespace: `import * as g from "./cst-types/index.js"`
- Parser is cast to typed version: `new BaseParser() as g.Parser`

### Effect Framework

- CLI uses Effect for type-safe error handling
- All side effects wrapped in `Effect.gen` and `yield*`
- Similar to Haskell's IO monad pattern

## Current Capabilities

✅ Parse Elm files using tree-sitter
✅ Generate TypeScript type definitions for Elm CST
✅ Print parsed AST for inspection

⚠️ TypeScript code generation not yet implemented

## Code Style

- **Strict TypeScript**: No implicit `any`, all strict flags enabled
- **Formatting**: Prettier with trailing commas, single quotes
- **Linting**: ESLint 9 with flat config, TypeScript recommended rules
- **Node.js Globals**: Defined in eslint.config.mjs (console, process, etc.)

## Testing

Currently no automated tests. Testing is done manually by parsing example Elm files.

## Notes for AI Agents

1. **Always use `.js` extensions in TypeScript imports** (NodeNext module resolution)
2. **Tree-sitter types are generated** - run `yarn gen:cst-types` after installing deps
3. **Effect CLI uses functional patterns** - wrap side effects in Effect types
4. **Nix provides consistent environment** - use `nix develop` when available
5. **The alias `elm-to-react` is only available in the Nix shell** - use `yarn dev` outside Nix

## Roadmap

Current phase: **Parser toolchain & CST type generation** ✅

Next phases:

1. Core emitter (literals, identifiers, functions)
2. Pattern matching with ts-pattern
3. TEA runtime with redux-loop
4. HTML to JSX conversion
5. JSON decoders/encoders
6. Routing

See README.md for detailed design decisions and full roadmap.
